<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ImemAct_SQL">
	<update id="imemUpdateGrd" parameterType="hashmap">
		UPDATE GRADE SET
		REG_DATE = SYSDATE,
		WLB = #{star1},
		PROMO_POSS = #{star2},
		C_CULT =
		#{star3},
		WFARE_PAY = #{star4},
		MGM = #{star5},
		EVAL = #{eval}
		WHERE
		DEL_CHK = 0
		AND GRADE_NO = #{gradeNo}
	</update>
	
	<select id="getSubResumCnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*) CNT
		FROM RESUM_SUPP RS
		JOIN RESUM R
		ON (RS.RESUM_NO = R.RESUM_NO)
		WHERE RS.DEL_CHK = 0
		AND	R.MEM_NO = #{memNo}
	</select>
	<!-- 리스트 -->
	<select id="getSubResum" parameterType="hashmap" resultType="hashmap">
		SELECT 
			EMP_NO, RESUM_NO, EMP_TITLE, DLINE,
			REG_DATE, FIND_CHK, PRCSS_STATE,
			RESUM_NAME
		FROM 
			(
			SELECT 
				RS.EMP_NO, RS.RESUM_NO,
				EMP_TITLE, TO_CHAR(EA.DLINE,'YYYY-MM-DD') DLINE,
				TO_CHAR(RS.REG_DATE,'YYYY-MM-DD') REG_DATE, FIND_CHK, PRCSS_STATE,
				RESUM_NAME, ROW_NUMBER() OVER(ORDER BY EA.DLINE) RNUM
			FROM RESUM_SUPP RS
			JOIN EMP_ANNC EA
			ON (RS.EMP_NO = EA.EMP_NO)
			JOIN RESUM R
			ON (RS.RESUM_NO = R.RESUM_NO)		
			WHERE RS.DEL_CHK = 0
			AND	R.MEM_NO = #{memNo}
			) SR
		WHERE SR.RNUM BETWEEN #{startCnt} AND #{endCnt}
	</select>
	
	<update id="changeSubResum" parameterType="hashmap" >
		UPDATE RESUM_SUPP SET
			RESUM_NO = #{cResumeNo}
		WHERE RESUM_NO = #{resumeNo}
		AND EMP_NO = #{empNo}
	</update>
	
	<delete id="DelSupResum" parameterType="hashmap" >
		DELETE RESUM_SUPP
		WHERE RESUM_NO = #{resumeNo}
		AND EMP_NO = #{empNo}
	</delete>
	
	<select id="getRecepReqCnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*) CNT
		FROM SUPP_REQ SR
        WHERE SR.MEM_NO = #{memNo}
	</select>
	<!-- 리스트 처리 -->
	<select id="getRecepReq" parameterType="hashmap" resultType="hashmap">
	    SELECT
	    	EMP_NO, 
	        EMP_TITLE, DLINE, C_NAME,
	        REG_DATE, REFUSE_CHK,
	        WLB, PROMO_POSS, C_CULT, WFARE_PAY, MGM
        FROM
		    (
		    SELECT 
		        SR.EMP_NO, 
		        EMP_TITLE, TO_CHAR(EA.DLINE,'YYYY-MM-DD') DLINE, C_NAME,
		        TO_CHAR(SR.REG_DATE,'YYYY-MM-DD') REG_DATE, REFUSE_CHK,
		        WLB, PROMO_POSS, C_CULT, WFARE_PAY, MGM, ROW_NUMBER() OVER(ORDER BY SR.REG_DATE, REFUSE_CHK) RNUM
		    FROM SUPP_REQ SR
		    JOIN EMP_ANNC EA
		    ON (SR.EMP_NO = EA.EMP_NO)
		    JOIN C_MEMBER CM
		    ON (CM.MEM_NO = EA.MEM_NO)
		    JOIN C_INFO CI
		    ON (CM.CORP_NO = CI.CORP_NO)
		    JOIN (
		        SELECT CORP_NO, 
		            ROUND(SUM(WLB)/COUNT(WLB)) WLB, 
		            ROUND(SUM(PROMO_POSS)/COUNT(PROMO_POSS)) PROMO_POSS, 
		            ROUND(SUM(C_CULT)/COUNT(C_CULT)) C_CULT, 
		            ROUND(SUM(WFARE_PAY)/COUNT(WFARE_PAY)) WFARE_PAY, 
		            ROUND(SUM(MGM)/COUNT(MGM)) MGM
		        FROM GRADE
		        WHERE DEL_CHK = 0
		        AND PRCSS_GBN = 1
		        GROUP BY CORP_NO
	        	) G
		    ON (G.CORP_NO = CM.CORP_NO) 
		    WHERE SR.MEM_NO = #{memNo}
	    	) SR
		WHERE SR.RNUM BETWEEN #{startCnt} AND #{endCnt}
	</select>
	
	<update id="recepReqRefuse" parameterType="hashmap">
		UPDATE SUPP_REQ
		SET REFUSE_CHK = 1
		WHERE MEM_NO = #{memNo} 
		AND EMP_NO = #{empno}
	</update>
</mapper>